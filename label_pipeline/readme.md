# RAG Evaluation Pipeline

This project sets up a complete pipeline for evaluating RAG (Retrieval-Augmented Generation) responses, with the following components:

- **Gradio Chatbot**: Frontend for interacting with the LLM
- **Label Studio**: For human evaluation of model responses
- **MinIO**: Object storage for queries and responses
- **PostgreSQL**: Database for Label Studio
- **Prometheus**: Metrics and monitoring

## Quick Start

### 1. Install Dependencies

```bash
chmod +x install_dependencies.sh
./install_dependencies.sh
```

### 2. Start the Docker Compose Pipeline

```bash
chmod +x start_pipeline.sh
./start_pipeline.sh
```

This will start Label Studio, MinIO, PostgreSQL, and all other services.

### 3. Test the Pipeline

```bash
python test_pipeline.py
```

This will add a test query and response to MinIO and Label Studio.

### 4. Run the Gradio Chatbot

With the project ID from the test script:

```bash
chmod +x run_gradio.sh
./run_gradio.sh PROJECT_ID
```

Replace PROJECT_ID with the actual Label Studio project ID.

## Accessing Services

- **Gradio Interface**: http://localhost:7860
- **Label Studio**: http://localhost:8090
  - Username: labelstudio@example.com
  - Password: labelstudio
- **MinIO Console**: http://localhost:9001
  - Username: your-access-key
  - Password: your-secret-key
- **Prometheus**: http://localhost:9090

## Integration Flow

1. User asks a question in the Gradio interface
2. Query is stored in MinIO (queries bucket)
3. Response is generated by the LLM
4. Response is stored in MinIO (responses bucket)
5. Task is created in Label Studio for evaluation
6. Evaluations can be exported from Label Studio

## Files

- `docker-compose.yaml`: Main configuration for all services
- `gradio_chatbot_with_storage.py`: Gradio app with MinIO integration
- `ls_integration.py`: Sets up Label Studio project and MinIO connection
- `sync_responses.py`: Syncs responses from MinIO to Label Studio
- `test_pipeline.py`: Adds test data to test the pipeline
- `monitor.py`: Monitors service status
- `start_pipeline.sh`: Script to start all services
- `run_gradio.sh`: Script to run the Gradio app

## Docker Compose Configuration

The `docker-compose.yaml` file includes the following services:

```yaml
services:
  prometheus:
    image: prom/prometheus:latest
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "9090:9090"
    volumes:
      - ${PWD}/prometheus.yaml:/etc/prometheus/prometheus.yml
    networks:
      - production_net

  nginx:
    image: nginx:latest
    ports:
      - "8080:80"
    volumes:
      - ${PWD}/nginx.conf:/etc/nginx/nginx.conf
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - production_net

  # Label Studio with PostgreSQL
  app-db:
    image: postgres:13
    container_name: app-db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=appdb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - production_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d appdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  label-studio:
    image: heartexlabs/label-studio:1.16.0
    container_name: label-studio
    depends_on:
      app-db:
        condition: service_healthy
    ports:
      - "8090:8080"  # Changed to 8090 to avoid conflict with nginx
    volumes:
      - ${PWD}/scripts:/label-studio/scripts
      - label_studio_data:/label-studio/data
    environment:
      - DJANGO_DB=default
      - POSTGRE_NAME=appdb
      - POSTGRE_USER=user
      - POSTGRE_PASSWORD=password
      - POSTGRE_PORT=5432
      - POSTGRE_HOST=app-db
      - LABEL_STUDIO_BASE_DATA_DIR=/label-studio/data
      - LABEL_STUDIO_USERNAME=labelstudio@example.com
      - LABEL_STUDIO_PASSWORD=labelstudio
      - LABEL_STUDIO_USER_TOKEN=ab9927067c51ff279d340d7321e4890dc2841c4a
    networks:
      - production_net

  # MinIO setup
  minio:
    image: minio/minio
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=your-access-key
      - MINIO_ROOT_PASSWORD=your-secret-key
    volumes:
      - minio_data:/data
    command: server /data --console-address ':9001'
    networks:
      - production_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  minio-init:
    image: minio/mc
    container_name: minio_init
    depends_on:
      minio:
        condition: service_healthy
    restart: "no"
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 your-access-key your-secret-key &&
      mc mb -p myminio/queries &&
      mc mb -p myminio/responses &&
      mc mb -p myminio/label-studio-data ||
      echo 'Buckets already exist'
      "
    networks:
      - production_net

  jupyter:
    image: quay.io/jupyter/minimal-notebook:latest
    container_name: jupyter
    ports:
      - "8888:8888"
    volumes:
      - ${PWD}/workspace:/home/jovyan/work
    environment:
      - MINIO_URL=http://minio:9000
      - MINIO_USER=your-access-key
      - MINIO_PASSWORD=your-secret-key
      - LABEL_STUDIO_URL=http://label-studio:8080
      - LABEL_STUDIO_USER_TOKEN=ab9927067c51ff279d340d7321e4890dc2841c4a
    networks:
      - production_net
    command: >
      bash -c "python3 -m pip install boto3 label-studio-sdk && start-notebook.sh"

  # Label Studio integration service  
  ls-integration:
    build:
      context: .
      dockerfile: Dockerfile.sync
    container_name: ls-integration
    depends_on:
      - label-studio
      - minio
    environment:
      - LABEL_STUDIO_URL=http://label-studio:8080
      - LABEL_STUDIO_USER_TOKEN=ab9927067c51ff279d340d7321e4890dc2841c4a
      - MINIO_URL=http://minio:9000
      - MINIO_USER=your-access-key
      - MINIO_PASSWORD=your-secret-key
    networks:
      - production_net
    restart: on-failure

volumes:
  minio_data:
  postgres_data:
  label_studio_data:

networks:
  production_net:
    external: true
```

## Setup Details

### Label Studio Configuration

Label Studio is configured with a PostgreSQL database to store project data, user information, and configurations. The project template includes a specialized interface for evaluating RAG responses with ratings and comments.

### MinIO Storage

MinIO serves as the object storage for both queries and responses. We create three buckets:
- `queries`: Stores user queries
- `responses`: Stores model responses
- `label-studio-data`: Used by Label Studio for additional data

### Integration Scripts

The `ls_integration.py` script sets up the initial Label Studio project and creates the MinIO connection. The `sync_responses.py` script periodically syncs new responses from MinIO to Label Studio for evaluation.

### Monitoring

The `monitor.py` script checks the status of all services and logs their status periodically. This helps ensure the pipeline is running smoothly.

## Customization

### Changing Credentials

To change the default credentials:

1. Update the environment variables in `docker-compose.yaml`
2. Update the corresponding values in the scripts

### Adding Custom Evaluation Metrics

To add custom evaluation metrics to Label Studio:

1. Modify the labeling configuration in `ls_integration.py`
2. Restart the Label Studio container

## Troubleshooting

### MinIO Connection Issues

If you encounter issues connecting to MinIO:

```bash
# Check if MinIO is running
docker ps | grep minio

# Check MinIO logs
docker logs minio
```

### Label Studio Sync Issues

If responses aren't showing up in Label Studio:

```bash
# Check ls-integration logs
docker logs ls-integration

# Manually run the sync script
docker exec -it ls-integration python sync_responses.py
```

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.
